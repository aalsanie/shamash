# Shamash ASM Reference Configuration (Schema v1)
#
# ASM engine: bytecode analysis (CI-friendly) + dependency graph + hotspots + scoring.
# This reference aims to be:
# - non-opinionated (no org-specific package names)
# - immediately useful (surfaces real issues like cycles, god classes, high coupling)
# - safe defaults (scans common build outputs; avoids gigantic dependency caches)
#
# NOTE: edit based on your team needs and architecture, view ./docs for customization references

version: 1

project:
  # Bytecode discovery happens by walking each root and matching directories/files using the globs below.
  bytecode:
    roots:
      - "."  # project root

    # Compiled class output directories.
    outputsGlobs:
      include:
        # Gradle (Java/Kotlin)
        - "**/build/classes/**"
        - "**/build/tmp/kotlin-classes/**"   # older Kotlin Gradle plugin
        # Maven
        - "**/target/classes/**"
        # IntelliJ
        - "**/out/production/**"
        # Eclipse
        - "**/bin/**"
        # Android (common javac intermediates)
        - "**/build/intermediates/javac/**"
      exclude:
        # Exclude test outputs (keep signal focused on production code)
        - "**/build/classes/**/test/**"
        - "**/build/tmp/kotlin-classes/**/test/**"
        - "**/target/test-classes/**"
        - "**/out/test/**"
        # Exclude generated outputs where possible
        - "**/build/**/generated/**"
        - "**/target/generated-sources/**"

    # Optional jars to include (useful if your repo produces shaded/fat jars, or publishes a library).
    # Shamash will only analyze jars present under the configured roots.
    jarGlobs:
      include:
        - "**/build/libs/*.jar"
        - "**/target/*.jar"
        - "**/libs/*.jar"
      exclude:
        - "**/*-sources.jar"
        - "**/*-javadoc.jar"
        - "**/.gradle/**"
        - "**/.m2/**"
        - "**/node_modules/**"

  scan:
    followSymlinks: false

    # PROJECT_ONLY keeps this plug-and-play and fast by focusing on your compiled outputs.
    # If you want to also ingest dependency jars as separate buckets, switch to:
    #   PROJECT_WITH_EXTERNAL_BUCKETS
    scope: PROJECT_ONLY

    # Safety valve for very large repos (increase if you know you have more compiled types).
    maxClasses: 50000

  validation:
    # Reference configs should not hide mistakes.
    unknownRule: ERROR

# Role detection (heuristics).
# These are intentionally broad so they work across frameworks (Spring, JAX-RS, Micronaut, Ktor, plain JVM apps).
roles:
  controller:
    description: "Inbound edge of the system: HTTP / RPC / entrypoint handlers"
    priority: 90
    match:
      anyOf:
        - annotationPrefix: "org.springframework.web.bind.annotation."
        - annotation: "javax.ws.rs.Path"
        - annotationPrefix: "jakarta.ws.rs."
        - packageContainsSegment: "controller"
        - packageContainsSegment: "controllers"
        - packageContainsSegment: "api"
        - packageContainsSegment: "web"
        - packageContainsSegment: "rest"
        - classNameEndsWith: "Controller"
        - classNameEndsWith: "Resource"
        - classNameEndsWith: "Endpoint"
        - classNameEndsWith: "Handler"

  service:
    description: "Business logic / use-cases"
    priority: 80
    match:
      anyOf:
        - annotation: "org.springframework.stereotype.Service"
        - annotationPrefix: "jakarta.inject."
        - annotationPrefix: "javax.inject."
        - packageContainsSegment: "service"
        - packageContainsSegment: "services"
        - packageContainsSegment: "usecase"
        - packageContainsSegment: "usecases"
        - packageContainsSegment: "application"
        - classNameEndsWith: "Service"
        - classNameEndsWith: "UseCase"
        - classNameEndsWith: "Interactor"

  repository:
    description: "Persistence boundary (DB / storage adapters)"
    priority: 70
    match:
      anyOf:
        - annotation: "org.springframework.stereotype.Repository"
        - packageContainsSegment: "repository"
        - packageContainsSegment: "repositories"
        - packageContainsSegment: "dao"
        - packageContainsSegment: "persistence"
        - classNameEndsWith: "Repository"
        - classNameEndsWith: "Dao"
        - classNameEndsWith: "DAO"

  domain:
    description: "Domain model / DTOs / entities"
    priority: 50
    match:
      anyOf:
        - packageContainsSegment: "domain"
        - packageContainsSegment: "model"
        - packageContainsSegment: "models"
        - packageContainsSegment: "entity"
        - packageContainsSegment: "entities"
        - packageContainsSegment: "dto"
        - classNameEndsWith: "Dto"

  config:
    description: "Configuration / wiring"
    priority: 40
    match:
      anyOf:
        - packageContainsSegment: "config"
        - packageContainsSegment: "configuration"
        - classNameEndsWith: "Config"
        - classNameEndsWith: "Configuration"

  util:
    description: "Shared utilities / helpers"
    priority: 10
    match:
      anyOf:
        - packageContainsSegment: "util"
        - packageContainsSegment: "utils"
        - packageContainsSegment: "common"
        - packageContainsSegment: "shared"
        - classNameEndsWith: "Util"
        - classNameEndsWith: "Utils"
        - classNameEndsWith: "Helper"

analysis:
  graphs:
    enabled: true
    granularity: PACKAGE
    includeExternalBuckets: false

  hotspots:
    enabled: true
    topN: 25
    includeExternal: false

  scoring:
    enabled: true
    model: V1

    # God-class scoring focuses on unusually large / highly coupled classes.
    godClass:
      enabled: true
      weights: null
      thresholds: null

    # Overall scoring summarizes health of the codebase at a glance.
    overall:
      enabled: true
      weights: null
      thresholds: null

# Baseline support.
# GENERATE writes a baseline file (useful on first run so teams can adopt gradually).
# Use NONE to disable baselines.
baseline:
  mode: GENERATE
  path: ".shamash/baseline/asm-baseline.json"

export:
  enabled: true
  overwrite: true

  outputDir: ".shamash/out/asm"

  # Human + machine-friendly outputs.
  formats:
    - SARIF
    - JSON
    - HTML
    - XML

  artifacts:
    # Facts are the raw data (best for post-processing and debugging).
    facts:
      enabled: true
      format: JSONL_GZ

    # Resolved role assignments per class.
    roles:
      enabled: true

    # The evaluated rule plan (what ran, with scopes, resolved rule IDs, etc.).
    rulePlan:
      enabled: true

    # Analysis results derived from facts (graphs + hotspots + scoring).
    analysis:
      enabled: true
      graphs: true
      hotspots: true
      scoring: true

rules:
  # -------- Graph rules (structural health) --------

  # NOTE: This spec intentionally has *no params*.
  # Graph knobs are configured under `analysis.graphs`.
  - type: graph
    name: noCycles
    enabled: true
    severity: ERROR

  - type: graph
    name: maxEdgeCount
    enabled: true
    severity: WARNING
    params:
      # A very high edge count usually means high coupling and poor modularity.
      # (Tweak upward for monorepos / huge libraries.)
      maxEdges: 2500

  - type: graph
    name: maxDependencyDensity
    enabled: true
    severity: WARNING
    params:
      # Density is a normalized coupling indicator (0..1 in typical graphs).
      maxDensity: 0.10

  # -------- Metrics rules (local complexity) --------

  - type: metrics
    name: maxMethodsPerClass
    enabled: true
    severity: WARNING
    params:
      maxMethods: 50

  - type: metrics
    name: maxFieldsPerClass
    enabled: true
    severity: WARNING
    params:
      maxFields: 25

  - type: metrics
    name: maxFanOut
    enabled: true
    severity: WARNING
    params:
      max: 30
      includeExternal: false

  - type: metrics
    name: maxFanIn
    enabled: true
    severity: WARNING
    params:
      max: 30
      includeExternal: false

  - type: metrics
    name: maxPackageSpread
    enabled: true
    severity: INFO
    params:
      max: 20
      includeExternal: false

  # -------- API surface rules (encapsulation) --------

  - type: api
    name: maxPublicTypes
    enabled: true
    severity: INFO
    params:
      # Large public surface area is often accidental; this pushes teams toward encapsulation.
      # 'max' is required by the rule spec.
      max: 300
      includeNested: true
      includeInterfaces: true
      includeEnums: true
      includeAnnotations: true

  # -------- Architecture rules (layering) --------

  - type: arch
    name: forbiddenRoleDependencies
    enabled: true
    severity: ERROR
    params:
      direction: direct
      # Non-opinionated layering: entrypoints should not talk to persistence directly.
      forbidden:
        controller:
          - repository

exceptions: []
