{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "shamash://psi/schema/v1/shamash-psi.schema.json",
  "title": "Shamash PSI Config Schema v1",
  "type": "object",
  "additionalProperties": false,
  "required": ["version", "project", "roles", "rules", "exceptions"],
  "properties": {
    "version": { "type": "integer", "const": 1 },
    "project": { "$ref": "#/$defs/project" },
    "roles": {
      "type": "object",
      "additionalProperties": { "$ref": "#/$defs/roleDef" }
    },
    "rules": {
      "type": "array",
      "items": { "$ref": "#/$defs/ruleDef" }
    },
    "exceptions": {
      "type": "array",
      "items": { "$ref": "#/$defs/exceptionDef" }
    }
  },
  "$defs": {
    "severity": { "type": "string", "enum": ["ERROR", "WARNING", "INFO"] },

    "unknownRulePolicy": {
      "type": "string",
      "enum": ["ERROR", "WARN", "IGNORE", "error", "warn", "ignore"]
    },

    "nonEmptyString": { "type": "string", "minLength": 1 },

    "stringList": {
      "type": "array",
      "items": { "type": "string" }
    },

    "globList": {
      "type": "array",
      "items": { "$ref": "#/$defs/nonEmptyString" }
    },

    "regexList": {
      "type": "array",
      "items": { "$ref": "#/$defs/nonEmptyString" }
    },

    "project": {
      "type": "object",
      "additionalProperties": false,
      "required": ["sourceGlobs", "validation"],
      "properties": {
        "rootPackage": { "$ref": "#/$defs/rootPackage" },
        "sourceGlobs": {
          "type": "object",
          "additionalProperties": false,
          "required": ["include", "exclude"],
          "properties": {
            "include": { "$ref": "#/$defs/globList" },
            "exclude": { "$ref": "#/$defs/globList" }
          }
        },
        "validation": {
          "type": "object",
          "additionalProperties": false,
          "required": ["unknownRule"],
          "properties": {
            "unknownRule": { "$ref": "#/$defs/unknownRulePolicy" }
          }
        }
      }
    },

    "rootPackage": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode", "value"],
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["AUTO", "EXPLICIT", "auto", "explicit"]
        },
        "value": { "type": "string" }
      }
    },

    "roleDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["priority", "match"],
      "properties": {
        "description": { "type": "string" },
        "priority": { "type": "integer", "minimum": 0, "maximum": 100 },
        "match": { "$ref": "#/$defs/matcher" }
      }
    },

    "matcher": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "anyOf": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/matcher" }
        },
        "allOf": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/matcher" }
        },
        "not": { "$ref": "#/$defs/matcher" },

        "annotation": { "$ref": "#/$defs/nonEmptyString" },
        "annotationPrefix": { "$ref": "#/$defs/nonEmptyString" },
        "packageRegex": { "$ref": "#/$defs/nonEmptyString" },
        "packageContainsSegment": { "$ref": "#/$defs/nonEmptyString" },
        "classNameRegex": { "$ref": "#/$defs/nonEmptyString" },
        "classNameEndsWith": { "$ref": "#/$defs/nonEmptyString" },

        "classNameEndsWithAny": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        },

        "hasMainMethod": { "type": "boolean" },
        "implements": { "$ref": "#/$defs/nonEmptyString" },
        "extends": { "$ref": "#/$defs/nonEmptyString" }
      },

      "oneOf": [
        { "required": ["anyOf"] },
        { "required": ["allOf"] },
        { "required": ["not"] },
        { "required": ["annotation"] },
        { "required": ["annotationPrefix"] },
        { "required": ["packageRegex"] },
        { "required": ["packageContainsSegment"] },
        { "required": ["classNameRegex"] },
        { "required": ["classNameEndsWith"] },
        { "required": ["classNameEndsWithAny"] },
        { "required": ["hasMainMethod"] },
        { "required": ["implements"] },
        { "required": ["extends"] }
      ]
    },

    "ruleScope": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "includeRoles": { "$ref": "#/$defs/stringList" },
        "excludeRoles": { "$ref": "#/$defs/stringList" },

        "includePackages": { "$ref": "#/$defs/regexList" },
        "excludePackages": { "$ref": "#/$defs/regexList" },

        "includeGlobs": { "$ref": "#/$defs/globList" },
        "excludeGlobs": { "$ref": "#/$defs/globList" }
      }
    },

    "ruleDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "name", "enabled", "severity"],
      "properties": {
        "type": { "$ref": "#/$defs/nonEmptyString" },
        "name": { "$ref": "#/$defs/nonEmptyString" },

        "roles": {
          "type": ["array", "null"],
          "items": { "$ref": "#/$defs/nonEmptyString" }
        },

        "enabled": { "type": "boolean" },
        "severity": { "$ref": "#/$defs/severity" },

        "scope": { "$ref": "#/$defs/ruleScope" },

        "params": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },

    "exceptionDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "reason", "match", "suppress"],
      "properties": {
        "id": { "$ref": "#/$defs/nonEmptyString" },
        "reason": { "$ref": "#/$defs/nonEmptyString" },

        "expiresOn": {
          "type": "string",
          "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
        },

        "match": { "$ref": "#/$defs/exceptionMatch" },

        "suppress": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        }
      }
    },

    "exceptionMatch": {
      "type": "object",
      "additionalProperties": false,
      "minProperties": 1,
      "properties": {
        "fileGlob": { "$ref": "#/$defs/nonEmptyString" },
        "packageRegex": { "$ref": "#/$defs/nonEmptyString" },
        "classNameRegex": { "$ref": "#/$defs/nonEmptyString" },
        "methodNameRegex": { "$ref": "#/$defs/nonEmptyString" },
        "fieldNameRegex": { "$ref": "#/$defs/nonEmptyString" },
        "hasAnnotation": { "$ref": "#/$defs/nonEmptyString" },
        "hasAnnotationPrefix": { "$ref": "#/$defs/nonEmptyString" },
        "role": { "$ref": "#/$defs/nonEmptyString" }
      }
    }
  }
}
