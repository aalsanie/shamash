# Shamash ASM Config v1 (PIT VIOLATION - TRIGGER ALL 18 BUILTIN RULES)
# -------------------------------------------------------------------
# This config is designed to:
# 1) PASS schema + semantic validation
# 2) Trigger at least one finding for EACH builtin rule in DefaultRuleRegistry.builtins()
#
# NOTE: Some rules currently cannot fire until engine param/id contracts are aligned with specs:
# - metrics.maxFieldsPerClass (engine reads max, spec enforces maxFields)
# - metrics.maxMethodsPerClass (engine reads max, spec enforces maxMethods)
# - arch.forbiddenRoleDependencies (engine reads forbid list, spec enforces forbidden map)
# - origin.allowOnlyRoot (engine id mismatch: arch.allowOnlyRoot vs origin.allowOnlyRoot)
#
# After fixing those mismatches, this file will trigger all 18 rules.

version: 1

project:
  bytecode:
    roots:
      - "."

    outputsGlobs:
      include:
        - "**/build/classes/**"
        - "**/target/classes/**"
        - "**/target/test-classes/**"
      exclude:
        - "**/.idea/**"
        - "**/out/**"
        - "**/generated/**"
        - "**/node_modules/**"
        - "**/.gradle/**"
        - "**/build/tmp/**"

    # We explicitly include the project jar so jar-origin rules can trigger.
    jarGlobs:
      include:
        - "**/build/libs/*.jar"
      exclude: []

  scan:
    # Must scan jars to trigger origin.forbiddenJarDependencies
    scope: ALL_SOURCES
    followSymlinks: false
    maxClasses: null
    maxJarBytes: null
    maxClassBytes: null

  validation:
    unknownRule: ERROR

# Roles mapped directly to pit-violation package layout.
roles:
  api:
    priority: 100
    description: "com.acme.api"
    match:
      anyOf:
        - packageRegex: "^com\\.acme\\.api(\\..*)?$"

  core:
    priority: 90
    description: "com.acme.core"
    match:
      anyOf:
        - packageRegex: "^com\\.acme\\.core(\\..*)?$"

  infra:
    priority: 80
    description: "com.acme.infra"
    match:
      anyOf:
        - packageRegex: "^com\\.acme\\.infra(\\..*)?$"

  a:
    priority: 70
    description: "com.acme.a"
    match:
      anyOf:
        - packageRegex: "^com\\.acme\\.a(\\..*)?$"

  b:
    priority: 60
    description: "com.acme.b"
    match:
      anyOf:
        - packageRegex: "^com\\.acme\\.b(\\..*)?$"

  forbidden:
    priority: 50
    description: "com.acme.forbidden"
    match:
      anyOf:
        - packageRegex: "^com\\.acme\\.forbidden(\\..*)?$"

  annotations:
    priority: 40
    description: "com.acme.annotations"
    match:
      anyOf:
        - packageRegex: "^com\\.acme\\.annotations(\\..*)?$"

analysis:
  graphs:
    enabled: true
    granularity: PACKAGE
    includeExternalBuckets: false

  hotspots:
    enabled: false
    topN: 30
    includeExternal: false

  scoring:
    enabled: false
    model: V1
    godClass:
      enabled: false
      weights: null
      thresholds: null
    overall:
      enabled: false
      weights: null
      thresholds: null

baseline:
  mode: NONE
  path: ".shamash/baseline/shamash-asm.baseline.json"

export:
  enabled: true
  outputDir: ".shamash/reports/asm"
  formats: [JSON,HTML,SARIF,XML]
  overwrite: true
  artifacts:
    facts:
      enabled: true
      # JSONL_GZ (recommended) | JSON will blow up on large projects
      format: JSONL_GZ

    roles:
      enabled: true

    rulePlan:
      enabled: true

    analysis:
      enabled: true
      # When enabled=true, flags default to true if omitted.
      graphs: true
      hotspots: true
      scoring: true

rules:
  # ---------------------------------------------------------------------------
  # api.*
  # ---------------------------------------------------------------------------

  # 1) api.forbiddenAnnotationUsage
  - type: api
    name: forbiddenAnnotationUsage
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/core/CoreService.class"
    params:
      forbid:
        - "^com\\.acme\\.annotations\\.InternalApi$"

  # 2) api.forbiddenInternalNamePatterns
  - type: api
    name: forbiddenInternalNamePatterns
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/api/GeneratedProxy.class"
    params:
      forbid:
        # internalName uses slashes; this still matches
        - ".*GeneratedProxy.*"

  # 3) api.maxPublicTypes
  - type: api
    name: maxPublicTypes
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includePackages:
        - "^com\\.acme\\.api$"
    params:
      # com.acme.api has multiple public types; force a violation
      max: 1

  # ---------------------------------------------------------------------------
  # arch.*
  # ---------------------------------------------------------------------------

  # 4) arch.allowedPackages
  # Make the API role violate allowed package constraints.
  - type: arch
    name: allowedPackages
    roles:
      - api
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/api/PublicApi1.class"
    params:
      allowPackages:
        - "^com\\.acme\\.core(\\..*)?$"

  # 5) arch.forbiddenPackages
  - type: arch
    name: forbiddenPackages
    roles:
      - forbidden
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/forbidden/BadPlace.class"
    params:
      forbidPackages:
        - "^com\\.acme\\.forbidden(\\..*)?$"


  # 7) arch.forbiddenRoleDependencies
  # Scope to InfraRepo (infra) + PublicApi1 (api) to get infra->api edge.
  - type: arch
    name: forbiddenRoleDependencies
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/infra/InfraRepo.class"
        - "**/com/acme/api/PublicApi1.class"
    params:
      direction: DIRECT
      forbidden:
        infra:
          - api

  # ---------------------------------------------------------------------------
  # origin.*
  # ---------------------------------------------------------------------------

  # 8) origin.forbiddenJarDependencies
  # Uses the built jar entry paths to ensure originKind=JAR_ENTRY is involved.
  - type: origin
    name: forbiddenJarDependencies
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/build/libs/*.jar!/com/acme/core/CoreService.class"
        - "**/build/libs/*.jar!/com/acme/infra/InfraRepo.class"
    params:
      forbid:
        - from: ".*build/libs/.*\\.jar$"
          to: ".*build/libs/.*\\.jar$"

  # ---------------------------------------------------------------------------
  # graph.*
  # ---------------------------------------------------------------------------

  # A<->B cycle exists in pit-violation (com.acme.a.A <-> com.acme.b.B)

  # 10) graph.noCycles
  - type: graph
    name: noCycles
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/a/A.class"
        - "**/com/acme/b/B.class"
    params: {}

  # 11) graph.maxCycles
  - type: graph
    name: maxCycles
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/a/A.class"
        - "**/com/acme/b/B.class"
    params:
      maxCycles: 0

  # 12) graph.maxEdgeCount
  - type: graph
    name: maxEdgeCount
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/a/A.class"
        - "**/com/acme/b/B.class"
    params:
      # A->B and B->A => 2 edges, so 1 forces violation
      maxEdges: 1

  # 13) graph.maxDependencyDensity
  - type: graph
    name: maxDependencyDensity
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/a/A.class"
        - "**/com/acme/b/B.class"
    params:
      maxDensity: 0.0

  # ---------------------------------------------------------------------------
  # metrics.*
  # ---------------------------------------------------------------------------

  # 14) metrics.maxFanIn
  - type: metrics
    name: maxFanIn
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/core/CoreService.class"
        - "**/com/acme/infra/InfraRepo.class"
    params:
      max: 0
      includeExternal: false

  # 15) metrics.maxFanOut
  - type: metrics
    name: maxFanOut
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/core/CoreService.class"
        - "**/com/acme/infra/InfraRepo.class"
    params:
      max: 0
      includeExternal: false

  # 16) metrics.maxFieldsPerClass
  - type: metrics
    name: maxFieldsPerClass
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/core/CoreService.class"
    params:
      maxFields: 0

  # 17) metrics.maxMethodsPerClass
  - type: metrics
    name: maxMethodsPerClass
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/core/CoreService.class"
    params:
      maxMethods: 0

  # 18) metrics.maxPackageSpread
  - type: metrics
    name: maxPackageSpread
    roles: null
    enabled: true
    severity: ERROR
    scope:
      includeGlobs:
        - "**/com/acme/core/CoreService.class"
        - "**/com/acme/infra/InfraRepo.class"
    params:
      max: 0
      includeExternal: false

exceptions: []
